name: Validate Token List

on:
  push:
    paths:
      - 'tokenlist.json'
      - 'metamask-submission.json'
  pull_request:
    paths:
      - 'tokenlist.json'
      - 'metamask-submission.json'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate JSON formatting
        run: |
          node -e "require('fs').readFileSync('tokenlist.json')" && echo "✓ tokenlist.json is valid"
          node -e "require('fs').readFileSync('metamask-submission.json')" && echo "✓ metamask-submission.json is valid"

      - name: Check token list schema
        run: |
          node -e "
          const list = require('./tokenlist.json');
          if (!list.name || !list.tokens) {
            throw new Error('Invalid token list schema');
          }
          console.log('✓ Token list has required fields');
          console.log('✓ Total tokens:', list.tokens.length);
          "

      - name: Validate token addresses
        run: |
          node -e "
          const list = require('./tokenlist.json');
          list.tokens.forEach((token, idx) => {
            if (!token.address || !token.address.match(/^0x[a-fA-F0-9]{40}$/)) {
              throw new Error(\`Token \${idx}: Invalid address format\`);
            }
            if (!token.symbol || !token.name || token.decimals === undefined) {
              throw new Error(\`Token \${idx}: Missing required fields\`);
            }
          });
          console.log('✓ All tokens have valid addresses and required fields');
          "

      - name: Create validation report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const list = JSON.parse(fs.readFileSync('tokenlist.json', 'utf8'));
            
            const report = `
            # Token List Validation Report
            
            - ✅ JSON is valid
            - ✅ Schema is correct
            - ✅ ${list.tokens.length} tokens found
            - ✅ All addresses are valid
            
            ## Tokens:
            ${list.tokens.map(t => `- ${t.symbol} (${t.name}) - Chain ${t.chainId}`).join('\n')}
            `;
            
            console.log(report);
